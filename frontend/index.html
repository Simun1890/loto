<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <title>Loto 6/45</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        input, button {
            margin: 5px 0;
        }

        #qrCode {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Loto 6/45</h1>

    <!-- Login / Logout -->
    <div id="authButtons">
        <button id="loginBtn">Login</button>
    </div>

    <!-- Info o kolu -->
    <div id="roundInfo">
        <p>Učitavanje...</p>
    </div>

    <!-- Forma za unos listića -->
    <div id="ticketForm" style="display:none;">
        <h2>Unos listića</h2>
        <label>Broj osobne iskaznice / putovnice:</label><br>
        <input type="text" id="personalId" maxlength="20"><br>
        <label>6-10 brojeva (odvojeno zarezom):</label><br>
        <input type="text" id="numbers" placeholder="npr. 1,2,3,4,5,6"><br>
        <button id="submitTicketBtn">Pošalji listić</button>
    </div>

    <!-- Prikaz QR koda -->
    <div id="qrCode">
        <img id="ticketQr" src="" alt="" />
    </div>

    <script>
        const baseUrl = window.location.origin;
        let userLoggedIn = false;

        // Dohvati podatke o prijavljenom korisniku
        async function checkUser() {
            const loginBtn = document.getElementById("loginBtn");
            loginBtn.addEventListener("click", () => { window.location.href = "/login"; });

            try {
                const res = await fetch("/user", { credentials: "include" });
                const data = await res.json();
                userLoggedIn = data.loggedIn;

                const authDiv = document.getElementById("authButtons");

                if (userLoggedIn) {
                    authDiv.innerHTML = `<p>Prijavljen: ${data.user.name}</p><button id="logoutBtn">Logout</button>`;
                    document.getElementById("ticketForm").style.display = 'block';
                    document.getElementById("logoutBtn").addEventListener("click", () => {
                        window.location.href = "/logout";
                    });
                } else {
                    // loginBtn ostaje vidljiv, forma skrivena
                    document.getElementById("ticketForm").style.display = 'none';
                }
            } catch (err) {
                console.error("Greška pri dohvat korisnika:", err);
                document.getElementById("ticketForm").style.display = 'none';
            }
        }

        // Dohvati info o trenutnom kolu
        async function loadRound() {
            try {
                const res = await fetch(`${baseUrl}/api/round`, { credentials: "include" });
                const data = await res.json();

                let html = '';
                if (data.active) {
                    html += `<p>Trenutno kolo aktivno.</p>`;
                    html += `<p>Broj listića: ${data.tickets}</p>`;
                    html += `<p>Izvučeni brojevi: ${data.numbers ? data.numbers.join(", ") : "-"}</p>`;
                } else {
                    html += `<p>Nema aktivnog kola.</p>`;
                    html += `<p>Broj listića: ${data.tickets}</p>`;
                    html += `<p>Izvučeni brojevi: ${data.numbers ? data.numbers.join(", ") : "-"}</p>`;
                }

                document.getElementById('roundInfo').innerHTML = html;
            } catch (err) {
                console.error(err);
                document.getElementById('roundInfo').innerHTML = `<p>Greška pri učitavanju kola.</p>`;
            }
        }

        // Funkcija za slanje listića
        async function submitTicket() {
            const personal_id = document.getElementById("personalId").value;
            const numbersStr = document.getElementById("numbers").value;
            const numbers = numbersStr.split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n));

            try {
                const res = await fetch(`${baseUrl}/tickets`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    credentials: "include",
                    body: JSON.stringify({ idNumber: personal_id, numbers })
                });

                const result = await res.json();

                if (!res.ok) {
                    alert(result.error);
                    return;
                }

                document.getElementById("ticketQr").src = result.qr;
                alert("Listić uspješno poslan! QR kod prikazan ispod.");
                loadRound(); // osvježi podatke o listićima
            } catch (err) {
                console.error(err);
                alert("Greška na serveru.");
            }
        }

        document.getElementById("submitTicketBtn").addEventListener("click", submitTicket);

        // Inicijalno učitavanje
        checkUser();
        loadRound();

        // Nakon redirecta Auth0 ukloni query string
        if (window.location.search.includes("code=")) {
            window.history.replaceState({}, document.title, "/");
        }
    </script>
</body>
</html>
