<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <title>Loto 6/45</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        input, button {
            margin: 5px 0;
        }

        #qrCode {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Loto 6/45</h1>

    <!-- Informacije o kolu -->
    <div id="roundInfo">
        <p>Učitavanje...</p>
    </div>

    <!-- Forma za unos listića -->
    <div id="ticketForm" style="display:none;">
        <h2>Unos listića</h2>
        <label>Broj osobne iskaznice / putovnice:</label><br>
        <input type="text" id="personalId" maxlength="20"><br>
        <label>6-10 brojeva (odvojeno zarezom):</label><br>
        <input type="text" id="numbers" placeholder="npr. 1,2,3,4,5,6"><br>
        <button onclick="submitTicket()">Pošalji listić</button>
    </div>

    <!-- Prikaz QR koda -->
    <div id="qrCode">
        <img id="ticketQr" src="" alt="" />
    </div>

    <script>
    const baseUrl = window.location.origin;

    // Dohvati info o trenutnom kolu
    async function loadRound() {
      const res = await fetch(`${baseUrl}/`);
      const data = await res.json();

      let html = '';
      if (data.active) {
        html += `<p>Trenutno kolo aktivno.</p>`;
        html += `<p>Broj listića: ${data.tickets}</p>`;
        html += `<p>Izvučeni brojevi: ${data.numbers ? data.numbers.join(", ") : "-"}</p>`;
        if (data.canSubmit) {
          document.getElementById('ticketForm').style.display = 'block';
        }
      } else {
        html += `<p>Nema aktivnog kola.</p>`;
        html += `<p>Broj listića: ${data.tickets}</p>`;
        html += `<p>Izvučeni brojevi: ${data.numbers ? data.numbers.join(", ") : "-"}</p>`;
      }

      document.getElementById('roundInfo').innerHTML = html;
    }

    // Funkcija za slanje listića
    async function submitTicket() {
      const personal_id = document.getElementById("personalId").value;
      const numbers = document.getElementById("numbers").value;

      try {
        const res = await fetch(`${baseUrl}/tickets`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ personal_id, numbers })
        });

        if (!res.ok) {
          const err = await res.json();
          alert(err.error);
          return;
        }

        const blob = await res.blob();
        document.getElementById("ticketQr").src = URL.createObjectURL(blob);
        alert("Listić uspješno poslan! QR kod prikazan ispod.");
      } catch (err) {
        console.error(err);
        alert("Greška na serveru.");
      }
    }

    // Učitaj podatke pri pokretanju stranice
    loadRound();
    </script>
</body>
</html>